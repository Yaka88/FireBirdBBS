name: Extract .tgz/.tar.gz and open PR

# 给 workflow 写权限以便创建 PR / 提交变更
permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '**/*.tgz'
      - '**/*.tar.gz'

jobs:
  extract-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Detect changed archives
        id: detect
        run: |
          set -euo pipefail
          before='${{ github.event.before }}'
          head='${{ github.sha }}'

          if [ "$before" = "0000000000000000000000000000000000000000" ]; then
            archives=$(git ls-files '*.tgz' '*.tar.gz' || true)
          else
            archives=$(git diff --name-only "$before" "$head" | grep -E '\.tgz$|\.tar\.gz$' || true)
          fi

          # 导出多行输出
          echo "archives<<EOF" >> $GITHUB_OUTPUT
          printf "%s\n" "$archives" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract archives safely into repo root
        id: extract
        run: |
          set -euo pipefail
          archives="${{ steps.detect.outputs.archives }}"

          if [ -z "$archives" ]; then
            echo "No archives detected."
            exit 0
          fi

          workspace="${GITHUB_WORKSPACE:-$(pwd)}"
          echo "Workspace: $workspace"

          IFS=$'\n'
          any=false
          for a in $archives; do
            [ -n "$a" ] || continue
            if [ ! -f "$a" ]; then
              echo "Archive not found (skipping): $a"
              continue
            fi

            echo "Checking $a for unsafe paths..."
            if tar -tzf "$a" | grep -E '(^/)|(\.\./)'; then
              echo "Unsafe paths detected in $a — skipping extraction to repo root."
              continue
            fi

            echo "Extracting $a -> $workspace"
            tar -xzf "$a" -C "$workspace"
            any=true
          done

          if [ "$any" = true ]; then
            echo "Extraction done. Uncommitted changes present."
          else
            echo "No safe archives were extracted."
          fi

      - name: Create Pull Request with extracted files
        # 这个 action 会把工作区里未提交的变更提交到新分支并创建 PR
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Extract archives:${{ steps.detect.outputs.archives }}
          branch: extract/${{ github.run_id }}
          title: 'Automated: Extract uploaded archive(s)'
          body: |
            This PR was opened automatically by a workflow that detected and extracted uploaded .tgz/.tar.gz archive(s):
            ${{ steps.detect.outputs.archives }}

            Please review the extracted files before merging.
          base: main
          labels: automated,extract
          draft: false
