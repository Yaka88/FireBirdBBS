name: Cross-compile for MIPS32 Little-Endian

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-mipsle:
    runs-on: ubuntu-20.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-mipsel-linux-gnu \
          g++-mipsel-linux-gnu \
          binutils-mipsel-linux-gnu \
          build-essential \
          wget \
          curl \
          file \
          bison \
          flex \
          texinfo \
          libncurses5-dev \
          gawk
        
    - name: Prepare build directories
      run: |
        mkdir -p $HOME/mipsle-build
        mkdir -p $HOME/mipsle-install
        cd $HOME/mipsle-build
        
    - name: Set environment variables
      run: |
        echo "MIPS_PREFIX=$HOME/mipsle-install" >> $GITHUB_ENV
        echo "MIPS_TARGET=mipsel-linux-gnu" >> $GITHUB_ENV
        echo "MIPS_CC=mipsel-linux-gnu-gcc" >> $GITHUB_ENV
        echo "MIPS_AR=mipsel-linux-gnu-ar" >> $GITHUB_ENV
        echo "MIPS_RANLIB=mipsel-linux-gnu-ranlib" >> $GITHUB_ENV
        echo "MIPS_CFLAGS=-mips32 -mabi=32 -EL -fno-stack-protector -fcommon -O2 -U_TIME_BITS -U_FILE_OFFSET_BITS -D_FILE_OFFSET_BITS=32 -g3 -gdwarf-2" >> $GITHUB_ENV
        echo "MIPS_LDFLAGS=-static -Wl,--no-as-needed" >> $GITHUB_ENV
        
    - name: Download and build termcap
      run: |
        cd $HOME/mipsle-build
        wget https://ftp.gnu.org/gnu/termcap/termcap-1.3.1.tar.gz
        tar xzf termcap-1.3.1.tar.gz
        cd termcap-1.3.1
        
        CC=$MIPS_CC \
        AR=$MIPS_AR \
        RANLIB=$MIPS_RANLIB \
        CFLAGS="$MIPS_CFLAGS" \
        ./configure --host=$MIPS_TARGET --prefix=$MIPS_PREFIX --enable-static --disable-shared
        
        make
        make install
        
        echo "termcap built successfully"
        ls -la $MIPS_PREFIX/lib/libtermcap.a
        
    - name: Download and build ncurses
      run: |
        cd $HOME/mipsle-build
        wget https://ftp.gnu.org/pub/gnu/ncurses/ncurses-5.9.tar.gz
        tar xzf ncurses-5.9.tar.gz
        cd ncurses-5.9
        
        CC=$MIPS_CC \
        CXX=mipsel-linux-gnu-g++ \
        AR=$MIPS_AR \
        RANLIB=$MIPS_RANLIB \
        CFLAGS="$MIPS_CFLAGS" \
        CXXFLAGS="$MIPS_CFLAGS" \
        ./configure \
          --host=$MIPS_TARGET \
          --prefix=$MIPS_PREFIX \
          --enable-static \
          --disable-shared \
          --without-cxx-binding \
          --without-ada \
          --without-manpages \
          --without-progs \
          --without-tests \
          --with-termlib \
          --with-default-terminfo-dir=/usr/share/terminfo \
          --with-terminfo-dirs=/usr/share/terminfo:/etc/terminfo
        
        make
        make install
        
        echo "ncurses built successfully"
        ls -la $MIPS_PREFIX/lib/libncurses.a
        
    - name: Download and build libxcrypt (replacement for libcrypt)
      run: |
        cd $HOME/mipsle-build
        wget https://github.com/besser82/libxcrypt/releases/download/v4.4.28/libxcrypt-4.4.28.tar.xz
        tar xf libxcrypt-4.4.28.tar.xz
        cd libxcrypt-4.4.28
        
        CC=$MIPS_CC \
        AR=$MIPS_AR \
        RANLIB=$MIPS_RANLIB \
        CFLAGS="$MIPS_CFLAGS" \
        ./configure \
          --host=$MIPS_TARGET \
          --prefix=$MIPS_PREFIX \
          --enable-static \
          --disable-shared \
          --disable-failure-tokens \
          --enable-obsolete-api=glibc
        
        make
        make install
        
        echo "libxcrypt built successfully"
        ls -la $MIPS_PREFIX/lib/libcrypt.a
        
    - name: Build libBBS
      run: |
        cd $GITHUB_WORKSPACE/bbssrc/lib/libBBS
        
        # Build libBBS
        make clean || true
        
        CC=$MIPS_CC \
        AR=$MIPS_AR \
        RANLIB=$MIPS_RANLIB \
        CFLAGS="$MIPS_CFLAGS -I$GITHUB_WORKSPACE/bbssrc/include" \
        make all
        
        echo "libBBS built successfully"
        ls -la ../libBBS.a
        file ../libBBS.a
        
    - name: Build BBS executables
      run: |
        cd $GITHUB_WORKSPACE/bbssrc/src
        
        # Clean previous builds
        make clean || true
        
        # Prepare version.h
        sh ver.sh ../include/version.h
        
        # Build all executables with static linking
        CC=$MIPS_CC \
        CFLAGS="$MIPS_CFLAGS -I$GITHUB_WORKSPACE/bbssrc/include -I$MIPS_PREFIX/include" \
        LIBS="-L$MIPS_PREFIX/lib -L$GITHUB_WORKSPACE/bbssrc/lib -static -ltermcap -lcrypt -lBBS" \
        BBSHOME=/home/bbs \
        BBS_UID=9999 \
        BBSGID=99 \
        OS_DEF="-DLINUX -DTERMIOS" \
        CSIE_DEF="-DSHOW_IDLE_TIME -DWITHOUT_CHROOT" \
        make all
        
        echo "BBS executables built successfully"
        ls -la bbsd chatd thread expire
        file bbsd chatd thread expire
        
    - name: Build utilities
      run: |
        cd $GITHUB_WORKSPACE/bbssrc/util
        
        # Check if util has Makefile
        if [ -f Makefile ]; then
          CC=$MIPS_CC \
          CFLAGS="$MIPS_CFLAGS -I$GITHUB_WORKSPACE/bbssrc/include -I$MIPS_PREFIX/include" \
          LIBS="-L$MIPS_PREFIX/lib -L$GITHUB_WORKSPACE/bbssrc/lib -static -ltermcap -lcrypt -lBBS" \
          make all || echo "Some utilities may have failed, continuing..."
        fi
        
        # Find all compiled executables
        find . -type f -executable -exec file {} \; | grep MIPS || true
        
    - name: Collect and package executables
      run: |
        mkdir -p $HOME/bbs-mipsle-binaries
        cd $GITHUB_WORKSPACE/bbssrc
        
        # Collect main executables
        if [ -f src/bbsd ]; then cp src/bbsd $HOME/bbs-mipsle-binaries/; fi
        if [ -f src/chatd ]; then cp src/chatd $HOME/bbs-mipsle-binaries/; fi
        if [ -f src/thread ]; then cp src/thread $HOME/bbs-mipsle-binaries/; fi
        if [ -f src/expire ]; then cp src/expire $HOME/bbs-mipsle-binaries/; fi
        
        # Collect .so files if any
        if [ -f src/paging.so ]; then cp src/paging.so $HOME/bbs-mipsle-binaries/; fi
        
        # Collect utilities
        find util -type f -executable -exec sh -c 'file "$1" | grep -q MIPS && cp "$1" $HOME/bbs-mipsle-binaries/' _ {} \; || true
        
        # Verify all files
        cd $HOME/bbs-mipsle-binaries
        echo "=== Built MIPS binaries ==="
        ls -lah
        file * || true
        
        # Create compressed archive
        cd $HOME
        tar czf bbs-mipsle-binaries.tar.gz bbs-mipsle-binaries/
        
        echo "=== Archive created ==="
        ls -lah bbs-mipsle-binaries.tar.gz
        
    - name: Copy archive to repository
      run: |
        cp $HOME/bbs-mipsle-binaries.tar.gz $GITHUB_WORKSPACE/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: bbs-mipsle-binaries
        path: |
          bbs-mipsle-binaries.tar.gz
          
    - name: Commit and push binaries
      run: |
        cd $GITHUB_WORKSPACE
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add bbs-mipsle-binaries.tar.gz
        git diff --cached --quiet || git commit -m "Add MIPS32LE cross-compiled binaries"
        git push || echo "Push failed, possibly no changes or permissions issue"
