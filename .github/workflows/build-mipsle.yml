name: Cross-compile for MIPS32 Little-Endian

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-mipsle:
    runs-on: ubuntu-20.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-mipsel-linux-gnu \
          g++-mipsel-linux-gnu \
          binutils-mipsel-linux-gnu \
          build-essential \
          wget \
          curl \
          file \
          bison \
          flex \
          texinfo \
          libncurses5-dev \
          gawk \
          gperf
        
        # Verify cross-compiler installation
        mipsel-linux-gnu-gcc --version
        mipsel-linux-gnu-ar --version
        
    - name: Prepare build directories
      run: |
        mkdir -p $HOME/mipsle-build
        mkdir -p $HOME/mipsle-install
        cd $HOME/mipsle-build
        
    - name: Set environment variables
      run: |
        echo "MIPS_PREFIX=$HOME/mipsle-install" >> $GITHUB_ENV
        echo "MIPS_TARGET=mipsel-linux-gnu" >> $GITHUB_ENV
        echo "MIPS_CC=mipsel-linux-gnu-gcc" >> $GITHUB_ENV
        echo "MIPS_AR=mipsel-linux-gnu-ar" >> $GITHUB_ENV
        echo "MIPS_RANLIB=mipsel-linux-gnu-ranlib" >> $GITHUB_ENV
        echo "MIPS_CFLAGS=-mips32 -mabi=32 -EL -fno-stack-protector -fcommon -O2 -U_TIME_BITS -U_FILE_OFFSET_BITS -D_FILE_OFFSET_BITS=32 -g3 -gdwarf-2" >> $GITHUB_ENV
        echo "MIPS_LDFLAGS=-static -Wl,--no-as-needed" >> $GITHUB_ENV
        
    - name: Download and build termcap
      run: |
        cd $HOME/mipsle-build
        wget https://ftp.gnu.org/gnu/termcap/termcap-1.3.1.tar.gz
        tar xzf termcap-1.3.1.tar.gz
        cd termcap-1.3.1
        
        CC=$MIPS_CC \
        AR=$MIPS_AR \
        RANLIB=$MIPS_RANLIB \
        CFLAGS="$MIPS_CFLAGS" \
        ./configure --host=$MIPS_TARGET --prefix=$MIPS_PREFIX --enable-static --disable-shared
        
        make -j$(nproc)
        make install
        
        if [ ! -f $MIPS_PREFIX/lib/libtermcap.a ]; then
          echo "ERROR: libtermcap.a not built!"
          exit 1
        fi
        
        echo "✓ termcap built successfully"
        ls -la $MIPS_PREFIX/lib/libtermcap.a
        file $MIPS_PREFIX/lib/libtermcap.a
        
    - name: Download and build ncurses
      run: |
        cd $HOME/mipsle-build
        wget https://ftp.gnu.org/pub/gnu/ncurses/ncurses-5.9.tar.gz
        tar xzf ncurses-5.9.tar.gz
        cd ncurses-5.9
        
        CC=$MIPS_CC \
        CXX=mipsel-linux-gnu-g++ \
        AR=$MIPS_AR \
        RANLIB=$MIPS_RANLIB \
        CFLAGS="$MIPS_CFLAGS" \
        CXXFLAGS="$MIPS_CFLAGS" \
        ./configure \
          --host=$MIPS_TARGET \
          --prefix=$MIPS_PREFIX \
          --enable-static \
          --disable-shared \
          --without-cxx-binding \
          --without-ada \
          --without-manpages \
          --without-progs \
          --without-tests \
          --with-termlib \
          --with-default-terminfo-dir=/usr/share/terminfo \
          --with-terminfo-dirs=/usr/share/terminfo:/etc/terminfo
        
        make -j$(nproc)
        make install
        
        if [ ! -f $MIPS_PREFIX/lib/libncurses.a ]; then
          echo "ERROR: libncurses.a not built!"
          exit 1
        fi
        
        echo "✓ ncurses built successfully"
        ls -la $MIPS_PREFIX/lib/libncurses.a
        file $MIPS_PREFIX/lib/libncurses.a
        
    - name: Download and build libxcrypt (replacement for libcrypt)
      run: |
        cd $HOME/mipsle-build
        wget https://github.com/besser82/libxcrypt/releases/download/v4.4.28/libxcrypt-4.4.28.tar.xz
        tar xf libxcrypt-4.4.28.tar.xz
        cd libxcrypt-4.4.28
        
        CC=$MIPS_CC \
        AR=$MIPS_AR \
        RANLIB=$MIPS_RANLIB \
        CFLAGS="$MIPS_CFLAGS" \
        ./configure \
          --host=$MIPS_TARGET \
          --prefix=$MIPS_PREFIX \
          --enable-static \
          --disable-shared \
          --disable-failure-tokens \
          --enable-obsolete-api=glibc
        
        make -j$(nproc)
        make install
        
        if [ ! -f $MIPS_PREFIX/lib/libcrypt.a ]; then
          echo "ERROR: libcrypt.a not built!"
          exit 1
        fi
        
        echo "✓ libxcrypt built successfully"
        ls -la $MIPS_PREFIX/lib/libcrypt.a
        file $MIPS_PREFIX/lib/libcrypt.a
        
    - name: Build libBBS
      run: |
        cd $GITHUB_WORKSPACE/bbssrc/lib/libBBS
        
        # Build libBBS with cross-compiler
        make clean || true
        
        make all \
          CC=$MIPS_CC \
          AR=$MIPS_AR \
          RANLIB=$MIPS_RANLIB \
          CFLAGS="$MIPS_CFLAGS -I$GITHUB_WORKSPACE/bbssrc/include"
        
        if [ ! -f ../libBBS.a ]; then
          echo "ERROR: libBBS.a not built!"
          exit 1
        fi
        
        echo "✓ libBBS built successfully"
        ls -la ../libBBS.a
        file ../libBBS.a
        
    - name: Build BBS executables
      run: |
        cd $GITHUB_WORKSPACE/bbssrc/src
        
        # Clean previous builds
        make clean || true
        
        # Prepare version.h
        sh ver.sh ../include/version.h
        
        # Build all executables with static linking
        # Note: -ldl, -lrpcsvc, -lbsd, -lnsl are typically included in static glibc or not needed
        make all \
          CC=$MIPS_CC \
          CFLAGS="$MIPS_CFLAGS -I$GITHUB_WORKSPACE/bbssrc/include -I$MIPS_PREFIX/include" \
          LIBS="-L$MIPS_PREFIX/lib -L$GITHUB_WORKSPACE/bbssrc/lib -static -lBBS -ltermcap -lcrypt" \
          BBSHOME=/home/bbs \
          BBS_UID=9999 \
          BBSGID=99 \
          OS_DEF="-DLINUX -DTERMIOS" \
          CSIE_DEF="-DSHOW_IDLE_TIME -DWITHOUT_CHROOT"
        
        echo "BBS executables built successfully"
        ls -la bbsd chatd thread expire 2>/dev/null || ls -la bbsd chatd thread 2>/dev/null || ls -la
        file bbsd 2>/dev/null || echo "bbsd not found"
        file chatd 2>/dev/null || echo "chatd not found"
        file thread 2>/dev/null || echo "thread not found"
        file expire 2>/dev/null || echo "expire not found"
        
    - name: Build utilities
      run: |
        cd $GITHUB_WORKSPACE/bbssrc/util
        
        # Check if util has Makefile
        if [ -f Makefile ]; then
          make all \
            CC=$MIPS_CC \
            CFLAGS="$MIPS_CFLAGS -I$GITHUB_WORKSPACE/bbssrc/include -I$MIPS_PREFIX/include" \
            LIBS="-L$MIPS_PREFIX/lib -L$GITHUB_WORKSPACE/bbssrc/lib -static -ltermcap -lcrypt -lBBS" \
            || echo "Some utilities may have failed, continuing..."
        fi
        
        # Find all compiled executables
        find . -type f -executable -exec file {} \; | grep MIPS || true
        
    - name: Collect and package executables
      run: |
        mkdir -p $HOME/bbs-mipsle-binaries
        cd $GITHUB_WORKSPACE/bbssrc
        
        # Collect main executables
        BUILT_COUNT=0
        if [ -f src/bbsd ]; then 
          cp src/bbsd $HOME/bbs-mipsle-binaries/
          echo "✓ Copied bbsd"
          BUILT_COUNT=$((BUILT_COUNT + 1))
        else
          echo "✗ bbsd not found"
        fi
        
        if [ -f src/chatd ]; then 
          cp src/chatd $HOME/bbs-mipsle-binaries/
          echo "✓ Copied chatd"
          BUILT_COUNT=$((BUILT_COUNT + 1))
        else
          echo "✗ chatd not found"
        fi
        
        if [ -f src/thread ]; then 
          cp src/thread $HOME/bbs-mipsle-binaries/
          echo "✓ Copied thread"
          BUILT_COUNT=$((BUILT_COUNT + 1))
        else
          echo "✗ thread not found"
        fi
        
        if [ -f src/expire ]; then 
          cp src/expire $HOME/bbs-mipsle-binaries/
          echo "✓ Copied expire"
          BUILT_COUNT=$((BUILT_COUNT + 1))
        else
          echo "✗ expire not found"
        fi
        
        # Collect .so files if any
        if [ -f src/paging.so ]; then 
          cp src/paging.so $HOME/bbs-mipsle-binaries/
          echo "✓ Copied paging.so"
          BUILT_COUNT=$((BUILT_COUNT + 1))
        fi
        
        # Collect utilities
        find util -type f -executable 2>/dev/null | while read f; do
          if file "$f" 2>/dev/null | grep -q MIPS; then
            cp "$f" "$HOME/bbs-mipsle-binaries/"
            echo "✓ Copied $(basename $f)"
            BUILT_COUNT=$((BUILT_COUNT + 1))
          fi
        done || true
        
        # Check if we have at least the main executable
        if [ $BUILT_COUNT -eq 0 ]; then
          echo "ERROR: No executables were built!"
          exit 1
        fi
        
        # Verify all files
        cd $HOME/bbs-mipsle-binaries
        echo ""
        echo "=== Built MIPS binaries (Total: $BUILT_COUNT) ==="
        ls -lah
        echo ""
        echo "=== File types ==="
        for f in *; do
          echo "--- $f ---"
          file "$f"
        done
        
        # Create compressed archive
        cd $HOME
        tar czf bbs-mipsle-binaries.tar.gz bbs-mipsle-binaries/
        
        echo ""
        echo "=== Archive created ==="
        ls -lah bbs-mipsle-binaries.tar.gz
        echo ""
        echo "Build completed successfully with $BUILT_COUNT binaries!"
        
    - name: Copy archive to repository
      run: |
        cp $HOME/bbs-mipsle-binaries.tar.gz $GITHUB_WORKSPACE/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: bbs-mipsle-binaries
        path: |
          bbs-mipsle-binaries.tar.gz
          
    - name: Commit and push binaries
      run: |
        cd $GITHUB_WORKSPACE
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add bbs-mipsle-binaries.tar.gz || true
        
        if git diff --cached --quiet; then
          echo "No changes to commit (binary already exists and unchanged)"
        else
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "Update MIPS32LE binaries - Built on $BUILD_DATE

Auto-generated by GitHub Actions
Target: mipsel-linux-gnu (MIPS32 Little-Endian)
Flags: -mips32 -mabi=32 -EL -fno-stack-protector -fcommon -O2
Static linking: Yes
Debug symbols: Yes (-g3 -gdwarf-2)"
          
          # Try to push, but don't fail if there are permission issues
          git push origin main || echo "Warning: Could not push to repository. Binary is available in artifacts."
        fi
    
    - name: Create build summary
      run: |
        cd $HOME/bbs-mipsle-binaries
        echo "## MIPS32LE Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Target**: mipsel-linux-gnu (MIPS32 Little-Endian)" >> $GITHUB_STEP_SUMMARY
        echo "- **ABI**: o32 (32-bit)" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Compiler Flags" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "$MIPS_CFLAGS" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Built Executables" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| File | Size | Type |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        for f in *; do
          SIZE=$(ls -lh "$f" | awk '{print $5}')
          TYPE=$(file -b "$f" | cut -d',' -f1-2)
          echo "| $f | $SIZE | $TYPE |" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Archive" >> $GITHUB_STEP_SUMMARY
        ARCHIVE_SIZE=$(ls -lh $HOME/bbs-mipsle-binaries.tar.gz | awk '{print $5}')
        echo "- **File**: bbs-mipsle-binaries.tar.gz" >> $GITHUB_STEP_SUMMARY
        echo "- **Size**: $ARCHIVE_SIZE" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Build completed successfully!" >> $GITHUB_STEP_SUMMARY
