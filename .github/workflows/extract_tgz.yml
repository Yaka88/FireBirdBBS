# 注意：这个 workflow 会把仓库中的 .tgz 文件解压并直接提交到 main 分支（不会创建 PR）。
# 使用前请确保 main 分支没有强制的保护规则阻止 workflow 用 GITHUB_TOKEN 推送（或准备一个有权限的 personal access token）。
# 触发方式：手动（workflow_dispatch）。如果你想自动触发可以改 triggers。
on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  extract-and-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        fetch-depth: 0

    - name: Set up git user
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Find and extract .tgz files into repo root
      env:
        TARGET_BRANCH: main
      run: |
        set -euo pipefail

        # 收集所有仓库内的 .tgz 文件（受 git 管理的文件）
        mapfile -d $'\0' TGZ_FILES < <(git ls-files -z -- '*.tgz' || true)

        if [ "${#TGZ_FILES[@]}" -eq 0 ]; then
          echo "No .tgz files tracked by git found. Exiting."
          exit 0
        fi

        TMPDIR=$(mktemp -d)
        echo "Using temp dir: $TMPDIR"

        # 为每个 .tgz 建个子目录解压，避免归档内的绝对路径或 ../ 问题直接写回仓库根
        for tgz in "${TGZ_FILES[@]}"; do
          base=$(basename "$tgz" .tgz)
          subdir="$TMPDIR/$base"
          mkdir -p "$subdir"
          echo "Extracting $tgz -> $subdir"
          # -x : extract, -z : gzip, -f : file
          tar -xzf "$tgz" -C "$subdir"
        done

        # 将解压出的内容合并回仓库根（覆盖同名文件）
        # 排除 .git 目录以防万一
        echo "Merging extracted content into repository root..."
        # 保留隐藏文件（dotfiles）
        shopt -s dotglob || true
        for d in "$TMPDIR"/*; do
          echo "Merging from $d"
          rsync -a --exclude='.git' "$d"/ .
        done

        # 清理
        rm -rf "$TMPDIR"

    - name: Commit and push changes to main
      env:
        TARGET_BRANCH: main
      run: |
        set -euo pipefail

        # 如果没有改动则退出
        if git status --porcelain | grep . >/dev/null; then
          git add -A
          git commit -m "ci: extract .tgz archives into repository root (by workflow)"
          # 直接推到 main 分支。确保 action 有推送权限或 branch protection 允许此操作。
          git push origin HEAD:refs/heads/${TARGET_BRANCH}
          echo "Pushed extracted files to branch ${TARGET_BRANCH}."
        else
          echo "No changes to commit."
        fi
